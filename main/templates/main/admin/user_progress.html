{% extends 'main/admin/base.html' %}
{% load static %}

{% block title %}Прогресс пользователя | ALMAU Adaptation{% endblock %}

{% block heading %}Прогресс пользователя: {{ user.get_full_name|default:user.username }}{% endblock %}

{% block content %}
<style>
/* Mobile responsive styles for user progress page */
@media (max-width: 768px) {
    .container-fluid {
        padding: 10px;
    }
    
    /* Statistics cards */
    .row.mb-4 .col-md-3 {
        margin-bottom: 15px;
    }
    
    .row.mb-4 .h2 {
        font-size: 1.5rem;
    }
    
    .row.mb-4 .text-muted {
        font-size: 0.8rem;
    }
    
    /* Table adjustments */
    .table-responsive {
        font-size: 12px;
    }
    
    .table th,
    .table td {
        padding: 8px 4px;
        vertical-align: middle;
    }
    
    /* Hide less important columns on mobile */
    .table th:nth-child(3),
    .table td:nth-child(3),
    .table th:nth-child(4),
    .table td:nth-child(4) {
        display: none;
    }
    
    /* Make lesson title more readable */
    .fw-semibold {
        font-size: 14px;
        word-break: break-word;
    }
    
    .text-muted {
        font-size: 11px;
    }
    
    /* Adjust progress bars */
    .progress {
        height: 6px;
        min-width: 40px;
    }
    
    .progress-text {
        font-size: 10px;
    }
    
    /* Make action buttons touch-friendly */
    .btn-group-sm .btn {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    /* Adjust badges */
    .badge {
        font-size: 10px;
        padding: 4px 6px;
    }
    
    /* Modal adjustments */
    .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .modal-body .row {
        flex-direction: column;
    }
    
    .modal-body .col-md-6 {
        width: 100%;
        margin-bottom: 15px;
    }
}

@media (max-width: 480px) {
    .container-fluid {
        padding: 5px;
    }
    
    .table-responsive {
        font-size: 11px;
    }
    
    .table th,
    .table td {
        padding: 6px 2px;
    }
    
    /* Hide more columns on very small screens */
    .table th:nth-child(2),
    .table td:nth-child(2) {
        display: none;
    }
    
    /* Make lesson info more compact */
    .d-flex.align-items-center {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .me-3 {
        margin-right: 0 !important;
        margin-bottom: 5px;
    }
    
    /* Adjust progress display */
    .d-flex.align-items-center .progress {
        width: 50px;
    }
    
    .d-flex.align-items-center small {
        font-size: 10px;
    }
}
</style>

<div class="container-fluid">
    <!-- Статистика пользователя -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-primary mb-1">{{ total_lessons }}</div>
                                <div class="text-muted">Всего уроков</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-success mb-1">{{ completed_lessons }}</div>
                                <div class="text-muted">Завершено</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-warning mb-1">{{ in_progress_lessons }}</div>
                                <div class="text-muted">В процессе</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h2 text-secondary mb-1">{{ not_started_lessons }}</div>
                                <div class="text-muted">Не начато</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Прогресс по урокам -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Детальный прогресс по урокам
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">Урок</th>
                                    <th class="border-0">Статус</th>
                                    <th class="border-0">Видео</th>
                                    <th class="border-0">Слайды</th>
                                    <th class="border-0">Общий прогресс</th>
                                    <th class="border-0">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in progress_data %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                                                                         <div class="me-3">
                                                 {% if data.lesson.video %}
                                                     <i class="fas fa-video text-primary"></i>
                                                 {% elif data.lesson.pdf_file %}
                                                     <i class="fas fa-file-pdf text-danger"></i>
                                                 {% else %}
                                                     <i class="fas fa-graduation-cap text-info"></i>
                                                 {% endif %}
                                             </div>
                                                                                         <div>
                                                 <div class="fw-semibold">{{ data.lesson.title }}</div>
                                                 <small class="text-muted">Длительность рассчитывается автоматически</small>
                                             </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if data.status == 'completed' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Завершен
                                            </span>
                                        {% elif data.status == 'in_progress' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>В процессе
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-times me-1"></i>Не начат
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.lesson.video %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 6px;">
                                                    <div class="progress-bar bg-primary" 
                                                         style="width: {{ data.video_progress|floatformat:0 }}%"></div>
                                                </div>
                                                <small class="text-muted">{{ data.video_progress|floatformat:0 }}%</small>
                                            </div>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                                                         <td>
                                         {% if data.lesson.pdf_file %}
                                             <div class="d-flex align-items-center">
                                                 <div class="progress me-2" style="width: 60px; height: 6px;">
                                                     <div class="progress-bar bg-danger" 
                                                          style="width: {{ data.slides_progress|floatformat:0 }}%"></div>
                                                 </div>
                                                 <small class="text-muted">
                                                     {{ data.slides_current }}/{{ data.slides_total }}
                                                 </small>
                                             </div>
                                         {% else %}
                                             <small class="text-muted">-</small>
                                         {% endif %}
                                     </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 80px; height: 8px;">
                                                <div class="progress-bar {% if data.status == 'completed' %}bg-success{% elif data.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}" 
                                                     style="width: {{ data.lesson_progress|floatformat:0 }}%"></div>
                                            </div>
                                            <small class="{% if data.status == 'completed' %}text-success{% elif data.status == 'in_progress' %}text-warning{% else %}text-muted{% endif %} fw-semibold">
                                                {{ data.lesson_progress|floatformat:0 }}%
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#lessonDetailModal{{ data.lesson.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not progress_data %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Нет данных о прогрессе. Возможно, уроки не загружены или пользователь не имеет прогресса.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка возврата -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'main:admin_users' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Назад к списку пользователей
            </a>
        </div>
    </div>
</div>

<!-- Модальные окна для детального просмотра -->
{% for data in progress_data %}
<div class="modal fade" id="lessonDetailModal{{ data.lesson.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Детали урока: {{ data.lesson.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if data.has_progress %}
                    <div class="row">
                        {% if data.lesson.video %}
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-video text-primary me-2"></i>
                                        Прогресс видео
                                    </h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>Просмотрено</small>
                                            <small>{{ data.video_progress|floatformat:1 }}%</small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-primary" 
                                                 style="width: {{ data.video_progress|floatformat:0 }}%"></div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="h5 text-primary mb-0">{{ data.video_current_time|floatformat:0 }}</div>
                                            <small class="text-muted">Текущее время (сек)</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 text-info mb-0">{{ data.video_total_time|floatformat:0 }}</div>
                                            <small class="text-muted">Общая длительность (сек)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                                                 {% if data.lesson.pdf_file %}
                         <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        Максимальный прогресс слайдов
                                    </h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>Максимальный прогресс</small>
                                            <small>{{ data.slides_current }}/{{ data.slides_total }}</small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-danger" 
                                                 style="width: {{ data.slides_progress|floatformat:0 }}%"></div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                                                                    <div class="h5 text-danger mb-0">{{ data.slides_current }}</div>
                                        <small class="text-muted">Максимальный слайд</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 text-info mb-0">{{ data.slides_total }}</div>
                                            <small class="text-muted">Всего слайдов</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        <div class="card border-0 {% if data.status == 'completed' %}bg-success bg-opacity-10{% else %}bg-warning bg-opacity-10{% endif %}">
                            <div class="card-body">
                                <h6 class="card-title {% if data.status == 'completed' %}text-success{% else %}text-warning{% endif %}">
                                    <i class="fas {% if data.status == 'completed' %}fa-check-circle{% else %}fa-clock{% endif %} me-2"></i>
                                    Статус завершения
                                </h6>
                                {% if data.status == 'completed' %}
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-check me-2"></i>
                                        Урок завершен! Пользователь изучил весь материал.
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-clock me-2"></i>
                                        Урок в процессе изучения. Необходимо завершить просмотр материала.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Прогресс не найден</h5>
                        <p class="text-muted">Пользователь еще не начинал изучение этого урока.</p>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
