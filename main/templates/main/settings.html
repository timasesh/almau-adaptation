{% extends 'main/base.html' %}
{% load static %}
{% load i18n %}
{% load translation_tags %}

{% block title %}{% trans "Настройки" %} - Adaptation AlmaU{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% include 'main/sidebar.html' %}
    
    <!-- Main content -->
    <div class="main-content" id="mainContent">
        <!-- Фиксированный логотип (не в потоке документа) -->
        <span class="user-badge fixed-almau-logo">AlmaUni</span>
        
        <div class="content-header">
            <div class="greeting">
                <h1>{% trans "Настройки" %}</h1>
            </div>
        </div>
        
        <div class="settings-content">
            <!-- Сообщения -->
            {% if messages %}
                <div class="messages-container">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">
                            <i class="fas fa-check-circle"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Настройки языка -->
            <div class="settings-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>{% trans "Язык интерфейса" %}</h2>
                        <p>{% trans "Выберите язык для отображения интерфейса сайта" %}</p>
                    </div>
                    
                    <form method="POST" class="language-form">
                        {% csrf_token %}
                        <div class="language-options">
                            {% for lang_code, lang_name in languages %}
                                <div class="language-option">
                                    <input type="radio" 
                                           id="lang_{{ lang_code }}" 
                                           name="language" 
                                           value="{{ lang_code }}"
                                           {% if current_language == lang_code %}checked{% endif %}
                                           onchange="this.form.submit();">
                                    <label for="lang_{{ lang_code }}" class="language-label">
                                        <div class="language-info">
                                            <span class="language-name">{{ lang_name }}</span>
                                            <span class="language-code">{{ lang_code|upper }}</span>
                                        </div>
                                        {% if current_language == lang_code %}
                                            <i class="fas fa-check language-check"></i>
                                        {% endif %}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Настройки темы -->
            <div class="settings-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>{% trans "Тема интерфейса" %}</h2>
                        <p>{% trans "Выберите светлую или темную тему для комфортного просмотра" %}</p>
                    </div>
                    
                    <div class="theme-options">
                        <div class="theme-option" data-theme="light">
                            <div class="theme-preview light-theme">
                                <div class="theme-header"></div>
                                <div class="theme-content">
                                    <div class="theme-sidebar"></div>
                                    <div class="theme-main"></div>
                                </div>
                            </div>
                            <div class="theme-info">
                                <span class="theme-name">{% trans "Светлая тема" %}</span>
                                <span class="theme-description">{% trans "Классический светлый дизайн" %}</span>
                            </div>
                            {% if current_theme == 'light' %}
                                <i class="fas fa-check theme-check"></i>
                            {% endif %}
                        </div>
                        
                        <div class="theme-option" data-theme="dark">
                            <div class="theme-preview dark-theme">
                                <div class="theme-header"></div>
                                <div class="theme-content">
                                    <div class="theme-sidebar"></div>
                                    <div class="theme-main"></div>
                                </div>
                            </div>
                            <div class="theme-info">
                                <span class="theme-name">{% trans "Темная тема" %}</span>
                                <span class="theme-description">{% trans "Современный темный дизайн" %}</span>
                            </div>
                            {% if current_theme == 'dark' %}
                                <i class="fas fa-check theme-check"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Тестовая область для проверки темной темы -->
            
        </div>
    </div>
</div>

<style>
/* Исправляем позиционирование логотипа AlmaUni справа сверху */
.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    position: relative;
}

.fixed-almau-logo {
    position: fixed !important;
    top: 32px !important;
    right: 30px !important;
    z-index: 1000 !important;
    background: #1976D2 !important;
    color: white !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-weight: bold !important;
    font-size: 14px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    white-space: nowrap !important;
}

.sidebar {
    width: 250px;
    min-width: 250px;
    max-width: 250px;
    transition: all 0.3s ease;
    overflow-x: hidden;
}

.sidebar-nav .nav-link {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sidebar .nav-text {
    display: inline-block;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}

.settings-btn.active {
    background: #e3f2fd !important;
    color: #1976D2 !important;
}

/* Настройки */
.settings-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.messages-container {
    margin-bottom: 30px;
}

.message {
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.message-success {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.settings-section {
    margin-bottom: 40px;
}

.settings-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.settings-header {
    margin-bottom: 30px;
}

.settings-header h2 {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0;
}

.settings-header p {
    font-size: 16px;
    color: #666;
    margin: 0;
}

.language-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}

.language-option {
    position: relative;
}

.language-option input[type="radio"] {
    display: none;
}

.language-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 25px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafafa;
}

.language-label:hover {
    border-color: #1976D2;
    background: #f8f9fa;
}

.language-option input[type="radio"]:checked + .language-label {
    border-color: #1976D2;
    background: #e3f2fd;
}

.language-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.language-name {
    font-size: 18px;
    font-weight: 500;
    color: #333;
}

.language-code {
    font-size: 14px;
    color: #666;
    font-weight: 400;
}

.language-check {
    color: #1976D2;
    font-size: 20px;
}



/* Адаптивность */
@media (max-width: 768px) {
    .fixed-almau-logo {
        right: 20px !important;
        top: 15px !important;
    }
    
    .settings-content {
        padding: 15px;
    }
    
    .settings-card {
        padding: 20px;
    }
    
    .language-label {
        padding: 15px 20px;
    }
    
    .language-name {
        font-size: 16px;
    }
}

/* Настройки темы */
.theme-options {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.theme-option {
    flex: 1;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: white;
}

.theme-option:hover {
    border-color: #1976D2;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.theme-option[data-theme="light"]:hover {
    border-color: #ffc107;
}

.theme-option[data-theme="dark"]:hover {
    border-color: #6f42c1;
}

.theme-option.active {
    border-color: #1976D2;
    background: #f8f9fa;
}

.theme-option[data-theme="light"].active {
    border-color: #ffc107;
    background: #fff8e1;
}

.theme-option[data-theme="dark"].active {
    border-color: #6f42c1;
    background: #f3e5f5;
}

.theme-preview {
    width: 100%;
    height: 80px;
    border-radius: 10px;
    margin-bottom: 15px;
    overflow: hidden;
    position: relative;
}

.light-theme {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.dark-theme {
    background: #343a40;
    border: 1px solid #495057;
}

.theme-header {
    height: 20px;
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
}

.dark-theme .theme-header {
    background: #495057;
    border-bottom-color: #6c757d;
}

.theme-content {
    display: flex;
    height: 60px;
}

.theme-sidebar {
    width: 30%;
    background: #ffffff;
    border-right: 1px solid #dee2e6;
}

.dark-theme .theme-sidebar {
    background: #495057;
    border-right-color: #6c757d;
}

.theme-main {
    flex: 1;
    background: #ffffff;
}

.dark-theme .theme-main {
    background: #495057;
}

.theme-info {
    text-align: center;
}

.theme-name {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    font-size: 16px;
}

.theme-description {
    display: block;
    color: #666;
    font-size: 14px;
}

.theme-check {
    position: absolute;
    top: 15px;
    right: 15px;
    color: #28a745;
    font-size: 18px;
    background: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Адаптивность для тем */
@media (max-width: 768px) {
    .theme-options {
        flex-direction: column;
        gap: 15px;
    }
    
    .theme-option {
        padding: 15px;
    }
    
    .theme-preview {
        height: 60px;
    }
}

/* Dark theme styles for settings page */
.theme-dark .settings-content {
    background: transparent !important;
    color: var(--text-primary) !important;
}

.theme-dark .settings-section {
    background: transparent !important;
    color: var(--text-primary) !important;
}

.theme-dark .settings-card {
    background: transparent !important;
    border: 2px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
    box-shadow: none !important;
}

.theme-dark .settings-header h2 {
    color: #ffffff !important;
    font-weight: bold !important;
}

.theme-dark .settings-header p {
    color: var(--text-secondary) !important;
}

.theme-dark .language-label {
    background: transparent !important;
    border: 2px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .language-label:hover {
    border-color: var(--accent-color) !important;
    background: rgba(100, 181, 246, 0.1) !important;
}

.theme-dark .language-option input[type="radio"]:checked + .language-label {
    border-color: var(--accent-color) !important;
    background: rgba(100, 181, 246, 0.2) !important;
}

.theme-dark .language-name {
    color: var(--text-primary) !important;
}

.theme-dark .language-code {
    color: var(--text-secondary) !important;
}

.theme-dark .language-check {
    color: var(--accent-color) !important;
}

.theme-dark .theme-option {
    background: transparent !important;
    border: 2px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .theme-option:hover {
    border-color: var(--accent-color) !important;
    background: rgba(100, 181, 246, 0.1) !important;
}

.theme-dark .theme-option.active {
    border-color: var(--accent-color) !important;
    background: rgba(100, 181, 246, 0.2) !important;
}

.theme-dark .theme-name {
    color: var(--text-primary) !important;
}

.theme-dark .theme-description {
    color: var(--text-secondary) !important;
}

.theme-dark .theme-check {
    color: var(--accent-color) !important;
    background: transparent !important;
}

/* Dark theme for test area */
.theme-dark .test-dark-theme {
    background: transparent !important;
    border: 2px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .test-dark-theme h1 {
    color: var(--text-primary) !important;
}

.theme-dark .test-dark-theme p {
    color: var(--text-primary) !important;
}

.theme-dark .test-dark-theme .test-card {
    background: transparent !important;
    border: 1px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .test-dark-theme .test-input {
    background: transparent !important;
    border: 1px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .test-dark-theme .test-input::placeholder {
    color: var(--text-secondary) !important;
}

/* Dark theme for buttons */
.theme-dark .btn {
    background: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: var(--button-text) !important;
}

.theme-dark .btn:hover {
    background: var(--accent-hover) !important;
    border-color: var(--accent-hover) !important;
}

.theme-dark .btn-primary {
    background: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: var(--button-text) !important;
}

.theme-dark .btn-secondary {
    background: transparent !important;
    border: 2px solid var(--text-primary) !important;
    color: var(--text-primary) !important;
}

.theme-dark .btn-secondary:hover {
    background: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: var(--button-text) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматически отправляем форму при выборе языка
    const languageInputs = document.querySelectorAll('input[name="language"]');
    
    languageInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Небольшая задержка для визуального эффекта
            setTimeout(() => {
                this.closest('form').submit();
            }, 200);
        });
    });

    // Обработка переключения темы
    const themeOptions = document.querySelectorAll('.theme-option');
    
    themeOptions.forEach(option => {
        option.addEventListener('click', function() {
            const selectedTheme = this.dataset.theme;
            
            console.log('Выбрана тема:', selectedTheme);
            
            // Убираем активный класс у всех опций
            themeOptions.forEach(opt => opt.classList.remove('active'));
            
            // Добавляем активный класс к выбранной опции
            this.classList.add('active');
            
            // Сохраняем тему в localStorage
            localStorage.setItem('selectedTheme', selectedTheme);
            
            // Применяем тему к странице (используем глобальную функцию из base.html)
            if (typeof applyTheme === 'function') {
                // Скрываем страницу на время переключения темы
                document.documentElement.classList.remove('theme-loaded');
                
                // Применяем тему
                applyTheme(selectedTheme);
                
                // Показываем страницу после применения темы
                setTimeout(() => {
                    document.documentElement.classList.add('theme-loaded');
                }, 150);
            } else {
                console.error('Функция applyTheme не найдена');
            }
            
            // Отправляем AJAX запрос для сохранения темы на сервере
            saveThemePreference(selectedTheme);
        });
    });
    
    // Функция сохранения предпочтения темы на сервере
    function saveThemePreference(theme) {
        fetch('{% url "main:set_theme" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                theme: theme
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Тема успешно сохранена');
            }
        })
        .catch(error => {
            console.error('Ошибка сохранения темы:', error);
        });
    }
    
    // Тестовые функции для проверки темной темы
    function testThemeSwitch() {
        const currentTheme = localStorage.getItem('selectedTheme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        console.log('Переключаем тему с', currentTheme, 'на', newTheme);
        
        if (typeof applyTheme === 'function') {
            applyTheme(newTheme);
            localStorage.setItem('selectedTheme', newTheme);
        } else {
            console.error('Функция applyTheme не найдена!');
        }
    }
    
    function checkThemeStatus() {
        const body = document.body;
        const html = document.documentElement;
        const computedStyle = getComputedStyle(document.documentElement);
        
        console.log('=== СТАТУС ТЕМЫ ===');
        console.log('Классы body:', body.className);
        console.log('Классы html:', html.className);
        console.log('localStorage theme:', localStorage.getItem('selectedTheme'));
        console.log('CSS переменные:');
        console.log('--bg-primary:', computedStyle.getPropertyValue('--bg-primary'));
        console.log('--text-primary:', computedStyle.getPropertyValue('--text-primary'));
        console.log('--card-bg:', computedStyle.getPropertyValue('--card-bg'));
        console.log('--border-color:', computedStyle.getPropertyValue('--border-color'));
        console.log('==================');
    }
    
    // Загружаем сохраненную тему при загрузке страницы и устанавливаем активную опцию
    const savedTheme = localStorage.getItem('selectedTheme') || 'light';
    const activeOption = document.querySelector(`[data-theme="${savedTheme}"]`);
    if (activeOption) {
        activeOption.classList.add('active');
    }
    
    // Применяем тему при загрузке страницы
    if (typeof applyTheme === 'function') {
        applyTheme(savedTheme);
    } else {
        console.error('Функция applyTheme не найдена при загрузке страницы!');
    }
});
</script>
{% endblock %}

    .fixed-almau-logo {

        right: 20px !important;

        top: 15px !important;

    }

    

    .settings-content {

        padding: 15px;

    }

    

    .settings-card {

        padding: 20px;

    }

    

    .language-label {

        padding: 15px 20px;

    }

    

    .language-name {

        font-size: 16px;

    }

}



/* Настройки темы */

.theme-options {

    display: flex;

    gap: 20px;

    margin-top: 20px;

}



.theme-option {

    flex: 1;

    border: 2px solid #e9ecef;

    border-radius: 15px;

    padding: 20px;

    cursor: pointer;

    transition: all 0.3s ease;

    position: relative;

    background: white;

}



.theme-option:hover {

    border-color: #1976D2;

    transform: translateY(-2px);

    box-shadow: 0 4px 15px rgba(0,0,0,0.1);

}



.theme-option[data-theme="light"]:hover {

    border-color: #ffc107;

}



.theme-option[data-theme="dark"]:hover {

    border-color: #6f42c1;

}



.theme-option.active {

    border-color: #1976D2;

    background: #f8f9fa;

}



.theme-option[data-theme="light"].active {

    border-color: #ffc107;

    background: #fff8e1;

}



.theme-option[data-theme="dark"].active {

    border-color: #6f42c1;

    background: #f3e5f5;

}



.theme-preview {

    width: 100%;

    height: 80px;

    border-radius: 10px;

    margin-bottom: 15px;

    overflow: hidden;

    position: relative;

}



.light-theme {

    background: #f8f9fa;

    border: 1px solid #dee2e6;

}



.dark-theme {

    background: #343a40;

    border: 1px solid #495057;

}



.theme-header {

    height: 20px;

    background: #e9ecef;

    border-bottom: 1px solid #dee2e6;

}



.dark-theme .theme-header {

    background: #495057;

    border-bottom-color: #6c757d;

}



.theme-content {

    display: flex;

    height: 60px;

}



.theme-sidebar {

    width: 30%;

    background: #ffffff;

    border-right: 1px solid #dee2e6;

}



.dark-theme .theme-sidebar {

    background: #495057;

    border-right-color: #6c757d;

}



.theme-main {

    flex: 1;

    background: #ffffff;

}



.dark-theme .theme-main {

    background: #495057;

}



.theme-info {

    text-align: center;

}



.theme-name {

    display: block;

    font-weight: 600;

    color: #333;

    margin-bottom: 5px;

    font-size: 16px;

}



.theme-description {

    display: block;

    color: #666;

    font-size: 14px;

}



.theme-check {

    position: absolute;

    top: 15px;

    right: 15px;

    color: #28a745;

    font-size: 18px;

    background: white;

    border-radius: 50%;

    width: 30px;

    height: 30px;

    display: flex;

    align-items: center;

    justify-content: center;

    box-shadow: 0 2px 5px rgba(0,0,0,0.1);

}



/* Адаптивность для тем */

@media (max-width: 768px) {

    .theme-options {

        flex-direction: column;

        gap: 15px;

    }

    

    .theme-option {

        padding: 15px;

    }

    

    .theme-preview {

        height: 60px;

    }

}

</style>



<script>

document.addEventListener('DOMContentLoaded', function() {

    // Автоматически отправляем форму при выборе языка

    const languageInputs = document.querySelectorAll('input[name="language"]');

    

    languageInputs.forEach(input => {

        input.addEventListener('change', function() {

            // Небольшая задержка для визуального эффекта

            setTimeout(() => {

                this.closest('form').submit();

            }, 200);

        });

    });



    // Обработка переключения темы

    const themeOptions = document.querySelectorAll('.theme-option');

    

    themeOptions.forEach(option => {

        option.addEventListener('click', function() {

            const selectedTheme = this.dataset.theme;

            

            console.log('Выбрана тема:', selectedTheme);

            

            // Убираем активный класс у всех опций

            themeOptions.forEach(opt => opt.classList.remove('active'));

            

            // Добавляем активный класс к выбранной опции

            this.classList.add('active');

            

            // Сохраняем тему в localStorage

            localStorage.setItem('selectedTheme', selectedTheme);

            

            // Применяем тему к странице (используем глобальную функцию из base.html)

            if (typeof applyTheme === 'function') {

                applyTheme(selectedTheme);

            } else {

                console.error('Функция applyTheme не найдена');

            }

            

            // Отправляем AJAX запрос для сохранения темы на сервере

            saveThemePreference(selectedTheme);

        });

    });

    

    // Функция сохранения предпочтения темы на сервере

    function saveThemePreference(theme) {

        fetch('{% url "main:set_theme" %}', {

            method: 'POST',

            headers: {

                'Content-Type': 'application/json',

                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value

            },

            body: JSON.stringify({

                theme: theme

            })

        })

        .then(response => response.json())

        .then(data => {

            if (data.success) {

                console.log('Тема успешно сохранена');

            }

        })

        .catch(error => {

            console.error('Ошибка сохранения темы:', error);

        });

    }

    

    // Тестовые функции для проверки темной темы

    function testThemeSwitch() {

        const currentTheme = localStorage.getItem('selectedTheme') || 'light';

        const newTheme = currentTheme === 'light' ? 'dark' : 'light';

        

        console.log('Переключаем тему с', currentTheme, 'на', newTheme);

        

        if (typeof applyTheme === 'function') {

            applyTheme(newTheme);

            localStorage.setItem('selectedTheme', newTheme);

        } else {

            console.error('Функция applyTheme не найдена!');

        }

    }

    

    function checkThemeStatus() {

        const body = document.body;

        const html = document.documentElement;

        const computedStyle = getComputedStyle(document.documentElement);

        

        console.log('=== СТАТУС ТЕМЫ ===');

        console.log('Классы body:', body.className);

        console.log('Классы html:', html.className);

        console.log('localStorage theme:', localStorage.getItem('selectedTheme'));

        console.log('CSS переменные:');

        console.log('--bg-primary:', computedStyle.getPropertyValue('--bg-primary'));

        console.log('--text-primary:', computedStyle.getPropertyValue('--text-primary'));

        console.log('--card-bg:', computedStyle.getPropertyValue('--card-bg'));

        console.log('--border-color:', computedStyle.getPropertyValue('--border-color'));

        console.log('==================');

    }

    

    // Загружаем сохраненную тему при загрузке страницы

    const savedTheme = localStorage.getItem('selectedTheme') || 'light';

    // Устанавливаем активную опцию

    const activeOption = document.querySelector(`[data-theme="${savedTheme}"]`);

    if (activeOption) {

        activeOption.classList.add('active');

    }

    

    // Применяем тему при загрузке страницы

    if (typeof applyTheme === 'function') {

        applyTheme(savedTheme);

    } else {

        console.error('Функция applyTheme не найдена при загрузке страницы!');

    }

});

</script>

